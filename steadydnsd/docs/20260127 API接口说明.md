# SteadyDNS API 接口说明

本文档提供了 SteadyDNS 项目的完整 API 接口说明，为前端开发提供参考。

## 1. 认证相关 API

### 1.1 登录
- **路径**: `/api/login`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "username": "admin",
    "password": "password"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refresh_token": "1_1618712345_1618712345",
      "user": {
        "id": 1,
        "username": "admin",
        "email": "admin@example.com"
      },
      "expires_in": 1800
    },
    "message": "登录成功"
  }
  ```

### 1.2 刷新令牌
- **路径**: `/api/refresh-token`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "refresh_token": "1_1618712345_1618712345"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refresh_token": "1_1618712345_1618712345",
      "user": {
        "id": 1,
        "username": "admin",
        "email": "admin@example.com"
      },
      "expires_in": 1800
    },
    "message": "令牌刷新成功"
  }
  ```

### 1.3 登出
- **路径**: `/api/logout`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "refresh_token": "1_1618712345_1618712345"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "登出成功"
  }
  ```

## 2. 健康检查 API

### 2.1 健康状态检查
- **路径**: `/api/health`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "status": "healthy",
      "timestamp": "2023-04-19T10:00:00Z",
      "system": {
        "cpu": 4,
        "goroutines": 50,
        "memory_allocated": 10485760,
        "memory_total": 20971520
      },
      "database": {
        "status": "healthy",
        "latency_ms": 1.23
      },
      "dns": {
        "status": "healthy",
        "is_running": true
      },
      "components": {
        "stats_manager": {
          "status": "healthy"
        },
        "config": {
          "status": "healthy"
        }
      }
    },
    "message": "健康检查完成"
  }
  ```

## 3. 服务器管理 API

### 3.1 获取服务器状态
- **路径**: `/api/server/status`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "dns_server": {
        "status": "running",
        "address": "0.0.0.0:53"
      },
      "http_server": {
        "status": "running",
        "address": "0.0.0.0:8080"
      },
      "forward_groups": 5,
      "cache_size": 1000
    }
  }
  ```

### 3.2 DNS 服务器操作
- **路径**: `/api/server/sdnsd/{action}`
- **方法**: `POST`
- **参数**: `action` - 操作类型 (start/stop/restart)
- **响应**:
  ```json
  {
    "success": true,
    "message": "DNS server started successfully"
  }
  ```

### 3.3 HTTP 服务器操作
- **路径**: `/api/server/httpd/{action}`
- **方法**: `POST`
- **参数**: `action` - 操作类型 (start/stop/restart)
- **响应**:
  ```json
  {
    "success": true,
    "message": "HTTP server started successfully"
  }
  ```

### 3.4 重载转发组
- **路径**: `/api/server/reload-forward-groups`
- **方法**: `POST`
- **响应**:
  ```json
  {
    "success": true,
    "message": "Forward groups reloaded successfully"
  }
  ```

### 3.5 设置日志级别
- **路径**: `/api/server/logging/level`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "level": "info"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "Log level set successfully",
    "level": "info"
  }
  ```

## 4. 缓存管理 API

### 4.1 获取缓存统计信息
- **路径**: `/api/cache/stats`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "total_items": 500,
      "hit_count": 1000,
      "miss_count": 200,
      "hit_rate": 0.83
    }
  }
  ```

### 4.2 清空缓存
- **路径**: `/api/cache/clear`
- **方法**: `POST`
- **响应**:
  ```json
  {
    "success": true,
    "message": "Cache cleared successfully"
  }
  ```

### 4.3 按域名清除缓存
- **路径**: `/api/cache/clear/{domain}`
- **方法**: `POST`
- **参数**: `domain` - 域名
- **响应**:
  ```json
  {
    "success": true,
    "message": "Cache cleared successfully for domain: example.com",
    "domain": "example.com"
  }
  ```

## 5. 配置管理 API

### 5.1 获取所有配置
- **路径**: `/api/config`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "Server": {
        "PORT": "8080",
        "GIN_MODE": "debug"
      },
      "Database": {
        "DB_PATH": "steadydns.db"
      }
    }
  }
  ```

### 5.2 获取指定节的配置
- **路径**: `/api/config/{section}`
- **方法**: `GET`
- **参数**: `section` - 配置节名称
- **响应**:
  ```json
  {
    "success": true,
    "section": "Server",
    "data": {
      "PORT": "8080",
      "GIN_MODE": "debug"
    }
  }
  ```

### 5.3 获取指定配置项
- **路径**: `/api/config/{section}/{key}`
- **方法**: `GET`
- **参数**: `section` - 配置节名称, `key` - 配置项名称
- **响应**:
  ```json
  {
    "success": true,
    "section": "Server",
    "key": "PORT",
    "value": "8080"
  }
  ```

### 5.4 更新配置项
- **路径**: `/api/config/{section}/{key}`
- **方法**: `PUT`
- **请求体**:
  ```json
  {
    "value": "8081",
    "user": "admin"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "配置更新成功",
    "section": "Server",
    "key": "PORT",
    "old_value": "8080",
    "new_value": "8081"
  }
  ```

### 5.5 重载配置
- **路径**: `/api/config/reload`
- **方法**: `POST`
- **响应**:
  ```json
  {
    "success": true,
    "message": "配置重载成功"
  }
  ```

### 5.6 备份配置
- **路径**: `/api/config/backup`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "comment": "备份配置",
    "user": "admin"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "配置备份成功",
    "backup_file": "config_backup_20230419_100000.json"
  }
  ```

### 5.7 恢复配置
- **路径**: `/api/config/restore`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "backup_file": "config_backup_20230419_100000.json",
    "user": "admin"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "配置恢复成功",
    "backup_file": "config_backup_20230419_100000.json"
  }
  ```

### 5.8 获取配置历史
- **路径**: `/api/config/history`
- **方法**: `GET`
- **参数**: `limit` - 限制返回记录数
- **响应**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": 1,
        "action": "update_config",
        "user": "admin",
        "timestamp": "2023-04-19T10:00:00Z",
        "changes": {
          "section": "Server",
          "key": "PORT",
          "old_value": "8080",
          "new_value": "8081"
        }
      }
    ],
    "count": 1
  }
  ```

### 5.9 重置为默认配置
- **路径**: `/api/config/reset`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "user": "admin"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "配置已重置为默认值"
  }
  ```

### 5.10 获取环境变量
- **路径**: `/api/config/env`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "PORT": "8080",
      "DB_PATH": "steadydns.db"
    },
    "count": 2
  }
  ```

### 5.11 设置环境变量
- **路径**: `/api/config/env`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "key": "PORT",
    "value": "8081",
    "user": "admin"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "环境变量设置成功",
    "key": "PORT",
    "value": "8081"
  }
  ```

### 5.12 验证配置
- **路径**: `/api/config/validate`
- **方法**: `POST`
- **响应**:
  ```json
  {
    "success": true,
    "message": "配置验证通过"
  }
  ```

## 6. BIND 服务器管理 API

### 6.1 获取 BIND 服务器状态
- **路径**: `/api/bind-server/status`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "status": "running"
    }
  }
  ```

### 6.2 BIND 服务器操作
- **路径**: `/api/bind-server/{action}`
- **方法**: `POST`
- **参数**: `action` - 操作类型 (start/stop/restart/reload)
- **响应**:
  ```json
  {
    "success": true,
    "message": "BIND server started successfully"
  }
  ```

### 6.3 获取 BIND 服务器统计信息
- **路径**: `/api/bind-server/stats`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "version": "9.16.1",
      "uptime": "1d 2h 3m",
      "queries": 10000,
      "errors": 50
    }
  }
  ```

### 6.4 检查 BIND 服务健康状态
- **路径**: `/api/bind-server/health`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "status": "running",
      "config_valid": true,
      "port_available": true,
      "overall_health": "healthy"
    }
  }
  ```

### 6.5 验证 BIND 配置
- **路径**: `/api/bind-server/validate`
- **方法**: `POST`
- **响应**:
  ```json
  {
    "success": true,
    "message": "BIND configuration validated successfully"
  }
  ```

### 6.6 获取 BIND 配置
- **路径**: `/api/bind-server/config`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "BIND_ADDRESS": "127.0.0.1",
      "ZONE_FILE_PATH": "/etc/bind/zones",
      "NAMED_CONF_PATH": "/etc/bind"
    }
  }
  ```

### 6.7 更新 BIND 配置
- **路径**: `/api/bind-server/config`
- **方法**: `PUT`
- **请求体**:
  ```json
  {
    "BIND_ADDRESS": "127.0.0.1",
    "ZONE_FILE_PATH": "/etc/bind/zones"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "BIND configuration updated successfully"
  }
  ```

## 7. 转发组管理 API

### 7.1 获取所有转发组
- **路径**: `/api/forward-groups`
- **方法**: `GET`
- **响应**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": 1,
        "domain": "Default",
        "description": "默认转发组",
        "is_default": true,
        "created_at": "2023-04-19T10:00:00Z"
      }
    ],
    "message": "获取转发组列表成功"
  }
  ```

### 7.2 创建转发组
- **路径**: `/api/forward-groups`
- **方法**: `POST`
- **请求体**:
  ```json
  {
    "domain": "example.com",
    "description": "Example 转发组",
    "is_default": false
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "id": 2,
      "domain": "example.com",
      "description": "Example 转发组",
      "is_default": false,
      "created_at": "2023-04-19T10:00:00Z"
    },
    "message": "转发组创建成功"
  }
  ```

### 7.3 更新转发组
- **路径**: `/api/forward-groups/{id}`
- **方法**: `PUT`
- **参数**: `id` - 转发组 ID
- **请求体**:
  ```json
  {
    "domain": "example.com",
    "description": "Updated Example 转发组"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "id": 2,
      "domain": "example.com",
      "description": "Updated Example 转发组",
      "is_default": false,
      "created_at": "2023-04-19T10:00:00Z"
    },
    "message": "转发组更新成功"
  }
  ```

### 7.4 删除转发组
- **路径**: `/api/forward-groups/{id}`
- **方法**: `DELETE`
- **参数**: `id` - 转发组 ID
- **响应**:
  ```json
  {
    "success": true,
    "message": "转发组删除成功"
  }
  ```

### 7.5 获取指定转发组
- **路径**: `/api/forward-groups/{id}`
- **方法**: `GET`
- **参数**: `id` - 转发组 ID
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "id": 1,
      "domain": "Default",
      "description": "默认转发组",
      "is_default": true,
      "created_at": "2023-04-19T10:00:00Z"
    },
    "message": "获取转发组成功"
  }
  ```

### 7.6 批量删除转发组
- **路径**: `/api/forward-groups?batch=true`
- **方法**: `DELETE`
- **请求体**:
  ```json
  [1, 2, 3]
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "成功删除 3 个转发组"
  }
  ```

### 7.7 测试域名匹配
- **路径**: `/api/forward-groups/test-domain-match`
- **方法**: `GET`
- **参数**: `domain` - 要测试的域名
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "domain": "example.com",
      "matched_group": "Default"
    },
    "message": "域名匹配测试成功"
  }
  ```

## 7. 通用响应格式

### 7.1 成功响应
```json
{
  "success": true,
  "data": {...}, // 响应数据
  "message": "操作成功" // 可选的消息
}
```

### 7.2 错误响应
```json
{
  "success": false,
  "error": "错误消息" // 错误详情
}
```

## 8. 认证方式

所有需要认证的 API 端点都需要在请求头中包含 JWT 令牌：

```
Authorization: Bearer <access_token>
```

## 9. 注意事项

1. **API 版本**: 当前 API 版本为 v1，所有路径都以 `/api/` 开头。
2. **请求方法**: 请严格按照 API 文档中指定的 HTTP 方法发送请求。
3. **认证**: 除了登录、刷新令牌和健康检查 API 外，所有其他 API 都需要认证。
4. **错误处理**: 请处理 API 返回的错误响应，根据 `success` 字段判断操作是否成功。
5. **参数验证**: 请确保发送的请求参数符合 API 文档中的要求。
6. **速率限制**: API 实现了速率限制，请勿频繁发送请求。
7. **超时**: API 实现了请求超时机制，长时间运行的操作可能会被中断。

## 10. 技术说明

- **服务器地址**: 默认情况下，API 服务器运行在 `http://localhost:8080`。
- **数据格式**: 所有请求和响应都使用 JSON 格式。
- **编码**: 请使用 UTF-8 编码发送请求。
- **内容类型**: 请设置 `Content-Type: application/json` 头。

## 11. 故障排除

### 11.1 常见错误

| 错误代码 | 描述 | 可能原因 |
|---------|------|----------|
| 401 | 未授权 | 令牌无效或已过期 |
| 403 | 禁止访问 | 没有权限执行此操作 |
| 404 | 未找到 | API 端点不存在 |
| 405 | 方法不允许 | 使用了错误的 HTTP 方法 |
| 400 | 错误的请求 | 请求参数无效 |
| 500 | 内部服务器错误 | 服务器内部出错 |

### 11.2 令牌问题

- **令牌过期**: 访问令牌默认 30 分钟过期，需要使用刷新令牌获取新令牌。
- **令牌无效**: 请确保令牌格式正确，没有被篡改。
- **刷新令牌无效**: 刷新令牌只能使用一次，使用后会失效。

### 11.3 服务器问题

- **DNS 端口占用**: 如果 53 端口被占用，DNS 服务器将无法启动。
- **数据库连接**: 确保数据库文件存在且可写。
- **配置错误**: 检查配置文件是否正确，特别是路径和端口设置。

## 12. 示例代码

### 12.1 使用 JavaScript 调用 API

```javascript
// 登录获取令牌
async function login() {
  const response = await fetch('/api/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      username: 'admin',
      password: 'password'
    })
  });
  
  const data = await response.json();
  if (data.success) {
    localStorage.setItem('token', data.data.access_token);
    return data.data;
  } else {
    throw new Error(data.error);
  }
}

// 调用需要认证的 API
async function getServerStatus() {
  const token = localStorage.getItem('token');
  const response = await fetch('/api/server/status', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  const data = await response.json();
  if (data.success) {
    return data.data;
  } else {
    throw new Error(data.error);
  }
}
```

### 12.2 使用 Python 调用 API

```python
import requests
import json

# 登录获取令牌
def login():
    url = 'http://localhost:8080/api/login'
    data = {
        'username': 'admin',
        'password': 'password'
    }
    response = requests.post(url, json=data)
    result = response.json()
    if result['success']:
        return result['data']['access_token']
    else:
        raise Exception(result['error'])

# 调用需要认证的 API
def get_server_status(token):
    url = 'http://localhost:8080/api/server/status'
    headers = {
        'Authorization': f'Bearer {token}'
    }
    response = requests.get(url, headers=headers)
    result = response.json()
    if result['success']:
        return result['data']
    else:
        raise Exception(result['error'])

# 使用示例
token = login()
status = get_server_status(token)
print(status)
```

## 13. 总结

本文档提供了 SteadyDNS 项目的完整 API 接口说明，包括认证、服务器管理、缓存管理、配置管理和 BIND 服务器管理等功能。前端开发人员可以根据本文档实现与后端的交互，构建完整的 SteadyDNS 管理界面。

如果在使用 API 过程中遇到问题，请参考故障排除部分，或联系后端开发人员获取帮助。