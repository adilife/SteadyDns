# DNS转发组功能更新说明（前端开发者）

## 一、主要更新内容

1. **域名匹配机制优化**
   - 实现了最长匹配算法，支持完全匹配和前缀+域名匹配
   - 示例：`www.jy.jcgov.gov.cn` 会匹配到 `jy.jcgov.gov.cn`，而不是 `jcgov.gov.cn`

2. **默认转发组特殊处理**
   - ID=1的转发组为默认转发组，域名为"Default"，描述为"Default Domain"
   - 默认转发组用于匹配未命中其他转发组的所有域名
   - 默认转发组**不可修改**域名和描述
   - 默认转发组**不可删除**
   - 系统启动时自动创建默认转发组（如果不存在）

3. **域名格式验证增强**
   - 域名总长度不能超过255个字符
   - 每个域名标签长度必须在1-63之间
   - 域名标签只能包含字母、数字和连字符
   - 域名标签不能以连字符开头或结尾

4. **新增API接口**
   - `GET /api/forward-groups/test-domain-match?domain=example.com`：测试域名匹配，返回匹配到的转发组名称

## 二、API接口变化

1. **转发组创建/更新**
   - 域名字段（`Name`）需要符合严格的DNS域名规范
   - ID=1的转发组不可修改域名和描述，前端需禁用对应编辑字段

2. **转发组删除**
   - 禁止删除ID=1的默认转发组，前端需禁用删除按钮

3. **域名匹配逻辑**
   - 转发组的域名现在用于匹配查询的DNS域名
   - 匹配规则：最长匹配优先，支持完全匹配和前缀+域名匹配

## 三、前端开发要求

1. **域名输入验证**
   - 添加域名格式验证，确保用户输入符合DNS规范
   - 提示信息需清晰，说明域名格式要求

2. **默认转发组处理**
   - 识别ID=1的默认转发组，禁用其域名和描述的编辑功能
   - 禁用默认转发组的删除按钮
   - 显示特殊标识，区分默认转发组和普通转发组

3. **域名匹配测试**
   - 可集成新增的域名匹配测试API，方便用户测试域名匹配结果
   - 提供可视化的匹配结果展示

4. **错误处理**
   - 处理域名格式验证失败的错误响应
   - 处理默认转发组修改/删除失败的错误响应

## 四、注意事项

1. **兼容性**
   - 现有转发组数据会自动迁移，ID=1的转发组会被设为默认转发组
   - 域名字段值会保持不变，仅增强验证逻辑

2. **性能提升**
   - 新增了域名匹配结果缓存，API响应速度会更快
   - 系统稳定性提升，减少API卡死情况

3. **测试建议**
   - 测试各种域名格式的输入验证
   - 测试不同层级域名的匹配结果
   - 测试默认转发组的特殊处理逻辑

## 五、示例代码

### 域名匹配测试API调用示例

```javascript
// 测试域名匹配
async function testDomainMatch(domain) {
  try {
    const response = await fetch(`/api/forward-groups/test-domain-match?domain=${encodeURIComponent(domain)}`);
    const result = await response.json();
    if (result.success) {
      console.log(`域名 ${domain} 匹配到转发组: ${result.data.matched_group}`);
      return result.data.matched_group;
    }
    throw new Error(result.message);
  } catch (error) {
    console.error('域名匹配测试失败:', error);
    return null;
  }
}
```

### 默认转发组处理示例

```javascript
// 转发组列表渲染
function renderForwardGroups(groups) {
  return groups.map(group => {
    const isDefaultGroup = group.id === 1;
    return `
      <div class="forward-group ${isDefaultGroup ? 'default-group' : ''}">
        <h3>${group.domain} ${isDefaultGroup ? '(默认)' : ''}</h3>
        <input 
          type="text" 
          name="domain" 
          value="${group.domain}" 
          disabled="${isDefaultGroup}"
          placeholder="请输入域名"
        />
        <input 
          type="text" 
          name="description" 
          value="${group.description}" 
          disabled="${isDefaultGroup}"
          placeholder="请输入描述"
        />
        <button 
          onclick="deleteForwardGroup(${group.id})"
          disabled="${isDefaultGroup}"
        >
          删除
        </button>
      </div>
    `;
  }).join('');
}
```

## 六、后续计划

- 提供更详细的域名匹配规则说明文档
- 增加域名匹配可视化工具
- 优化转发组管理界面交互

如有任何疑问或需要进一步的技术支持，请随时联系后端开发团队。